name: Deploy Shoply to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------
    # 1️⃣ SETUP SSH CONNECTION
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/privkey.pem
        chmod 600 ~/.ssh/privkey.pem

    # ---------------------------
    # 2️⃣ COPY FRONTEND (shoply-client)
    - name: Upload shoply-client to EC2
      run: |
        rsync -avz -e "ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no" \
        ./shoply-client/ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/var/www/shoply-client/

    # ---------------------------
    # 3️⃣ COPY BACKEND (shoply-api)
    - name: Upload shoply-api to EC2
      run: |
        rsync -avz -e "ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no" \
        ./shoply-api/ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/var/www/shoply-api/

    # ---------------------------
    # 4️⃣ INSTALL + BUILD + RESTART
    - name: Install deps and restart on EC2
      run: |
        ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          
          echo "➡ FRONTEND BUILD"
          cd /var/www/shoply-client
          npm install
          npm run build || echo "⚠ Build failed but continuing"

          echo "➡ BACKEND INSTALL"
          cd /var/www/shoply-api
          npm install

          echo "➡ Restart PM2"
          pm2 restart shoply-api || pm2 start index.js --name shoply-api

          echo "➡ Restart NGINX"
          sudo systemctl restart nginx

          echo "✔ DEPLOY COMPLETE!"
        EOF
