name: Deploy Shoply to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------
    # 1️⃣ SETUP SSH CONNECTION
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/privkey.pem
        chmod 600 ~/.ssh/privkey.pem

    # ---------------------------
    # 2️⃣ COPY CLIENT FILES TO EC2
    - name: Copy shoply-client to EC2
      run: |
        rsync -avz -e "ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no" \
        ./shoply-client/ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/var/www/shoply-client/

    # ---------------------------
    # 3️⃣ COPY API FILES TO EC2
    - name: Copy shoply-api to EC2
      run: |
        rsync -avz -e "ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no" \
        ./shoply-api/ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/var/www/shoply-api/

    # ---------------------------
    # 4️⃣ INSTALL DEPENDENCIES + RESTART SERVICES
    - name: Install & Restart on EC2
      run: |
        ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          echo "➡ Updating Client…"
          cd /var/www/shoply-client
          npm install
          npm run build

          echo "➡ Updating API…"
          cd /var/www/shoply-api
          npm install

          echo "➡ Restarting PM2…"
          pm2 restart all || pm2 start index.js --name shoply-api
          sudo systemctl restart nginx

          echo "✔ DONE DEPLOYING!"
        EOF
