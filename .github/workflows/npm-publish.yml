name: Deploy Shoply to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1Ô∏è‚É£ Setup SSH Key
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/privkey.pem
        chmod 600 ~/.ssh/privkey.pem

    # 2Ô∏è‚É£ Debug Repo Structure
    - name: List repo folders
      run: |
        echo "Repo directory:"
        ls -la
        echo "Frontend (shoply):"
        ls -la shoply || echo "‚ùå shoply NOT FOUND"
        echo "Backend (shoply-api):"
        ls -la shoply-api || echo "‚ùå shoply-api NOT FOUND"

    # 3Ô∏è‚É£ Upload Frontend (shoply ‚Üí /var/www/shoply-client)
    - name: Upload Frontend to EC2
      run: |
        rsync -avz --delete \
        -e "ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no" \
        shoply/ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/var/www/shoply-client/

    # 4Ô∏è‚É£ Upload Backend (shoply-api ‚Üí /var/www/shoply-api)
    - name: Upload Backend to EC2
      run: |
        rsync -avz --delete \
        -e "ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no" \
        shoply-api/ ubuntu@${{ secrets.EC2_PUBLIC_IP }}:/var/www/shoply-api/

    # 5Ô∏è‚É£ Install Dependencies + Restart Services
    - name: Install deps & restart on EC2
      run: |
        ssh -i ~/.ssh/privkey.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
        
          echo "‚û° Frontend BUILD"
          cd /var/www/shoply-client
          npm install
          npm run build || echo "‚ö† Build failed (still continuing)"

          echo "‚û° Backend INSTALL"
          cd /var/www/shoply-api
          npm install

          echo "‚û° Restart PM2"
          pm2 restart shoply-api || pm2 start index.js --name shoply-api

          echo "‚û° Restart Nginx"
          sudo systemctl restart nginx

          echo "üéâ Deployment Completed Successfully!"
        EOF
